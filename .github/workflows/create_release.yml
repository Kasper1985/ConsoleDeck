name: ConsoleDeck Service - Create new release version

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

env:
  WORK_DIR: ./ConsoleDeckService

jobs:
  build-and-release:
    runs-on: windows-latest
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Restore project dependencies
        working-directory: ${{ env.WORK_DIR }}
        run: dotnet restore

      - name: Run all unit tests
        working-directory: ${{ env.WORK_DIR }}
        run: dotnet test --no-restore

      - name: Publish a new release version
        working-directory: ${{ env.WORK_DIR }}
        run: dotnet publish -c Release -o release --no-restore .\ConsoleDeckService.csproj

      # If action was triggered my a tag, set RELEASE_VERSION to the triggering tag
      - name: Set RELEASE_VERSION from triggering tag
        if: ${{ github.ref_type == 'tag' }}
        run: |
          $raw = '${{ github.ref_name }}'
          if (-not $raw) {
            Write-Error "github.ref_name is empty despite ref_type == 'tag'"
          }
          $version = $raw -replace '^v',''
          if (-not $version) {
            Write-Error "Stripped version is empty (source: $raw)"
          }
          "RELEASE_VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "RELEASE_VERSION set to $version (from triggering tag)"

      # If action was not triggered by a tag, compute latest tag of type v*.*.* of fail if none
      - name: Get latest v*.*.* tag
        if: ${{ github.ref_type != 'tag' }}
        run: |
          git fetch --tags --force
          $tags = git tag --list 'v*.*.*'
          if (-not $tags) {
            Write-Error "No tags found matching pattern v*.*.*"
          }
          $latestTag = $tags | 
            Sort-Object {
              $ver = $_ -replace '^v',''
              try { [version]$ver } catch { [version]'0.0.0' }
            } -Descending |
            Select-Object -First 1
            if (-not $latestTag) {
              Write-Error "Failed to determine latest tag from v*.*.*"
            }
          $version = $latestTag -replace '^v',''
          if (-not $version) {
            Write-Error "Stripped version is empty (source: $latestTag)"
          }
          "RELEASE_VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "RELEASE_VERSION set to $version (computed from latest tag $latestTag)"

      - name: Create MSI package via Advanced Installer
        uses: caphyon/advinst-github-action@main
        with:
          advinst-version: '23.3'
          advinst-enable-automation: true
          aip-path: ${{ env.WORK_DIR }}/ConsoleDeck_Service.aip
          aip-commands: |
            SetVersion ${{ env.RELEASE_VERSION }}
            SetPackageName ConsoleDeckService_v${{ env.RELEASE_VERSION }}.msi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.WORK_DIR }}/ConsoleDeckService_v${{ env.RELEASE_VERSION }}.msi
          tag_name: v${{ env.RELEASE_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
